<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pointage Gabon Entreprise</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#2c3e50">
</head>
<body>

    <div class="container">
        <h1>Pointage Employ√©s UMAC</h1>
        <p>Enregistrez votre arriv√©e en un clic.</p>

        <div id="horloge-container">
            <p>Heure actuelle:</p>
            <div id="horloge">00:00:00</div>
        </div>

        <form id="pointageForm">
            <label for="nom">Nom complet :</label>
            <input type="text" id="nom" placeholder="Ex: Jean Marc" required>

            <div class="gps-box">
                <button type="button" onclick="obtenirLocation()" id="btnGps">
                    üìç V√©rifier ma position
                </button>
                <p id="status">Position non v√©rifi√©e</p>
            </div>

            <input type="hidden" id="lat">
            <input type="hidden" id="long">

            <button type="submit" id="btnValider" disabled>Valider l'arriv√©e</button>
        </form>
    </div>

    <script>
        /* 1. GESTION DE L'HORLOGE EN TEMPS R√âEL */
        function rafraichirHorloge() {
            const horlogeElement = document.getElementById('horloge');
            const maintenant = new Date();

            const heures = String(maintenant.getHours()).padStart(2, '0');
            const minutes = String(maintenant.getMinutes()).padStart(2, '0');
            const secondes = String(maintenant.getSeconds()).padStart(2, '0');

            horlogeElement.textContent = `${heures}:${minutes}:${secondes}`;
        }
        // Lance l'horloge et la met √† jour toutes les secondes
        setInterval(rafraichirHorloge, 1000);
        rafraichirHorloge();


        /* 2. GESTION DE LA G√âOLOCALISATION */
        function obtenirLocation() {
            const status = document.getElementById('status');
            const btnValider = document.getElementById('btnValider');

            if (!navigator.geolocation) {
                status.textContent = "La g√©olocalisation n'est pas support√©e";
            } else {
                status.textContent = "Recherche GPS en cours...";
                navigator.geolocation.getCurrentPosition(success, error);
            }

            function success(position) {
                // On remplit les champs cach√©s avec les coordonn√©es
                document.getElementById('lat').value = position.coords.latitude;
                document.getElementById('long').value = position.coords.longitude;
                
                status.textContent = "‚úÖ Position captur√©e !";
                status.style.color = "green";
                btnValider.disabled = false; // Active le bouton "Valider"
            }

            function error() {
                status.textContent = "‚ùå Erreur : Activez votre GPS";
                status.style.color = "red";
            }
        }


        /* 3. ENVOI DES DONN√âES AU SERVEUR PYTHON (FLASK) */
        const form = document.getElementById('pointageForm');

        form.addEventListener('submit', function(e) {
            e.preventDefault(); // Emp√™che la page de se recharger

            // On pr√©pare l'objet avec les donn√©es du formulaire
            const donnees = {
                nom: document.getElementById('nom').value,
                lat: document.getElementById('lat').value,
                long: document.getElementById('long').value
            };

            // On envoie ces donn√©es √† la route '/pointer' de notre fichier app.py
            fetch('/pointer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(donnees),
            })
            .then(response => response.json())
            .then(result => {
                // Si Python r√©pond avec succ√®s
                alert(result.message);
                form.reset(); // On vide le champ Nom
                document.getElementById('status').textContent = "Position non v√©rifi√©e";
                document.getElementById('status').style.color = "#7f8c8d";
                document.getElementById('btnValider').disabled = true;
            })
            .catch((error) => {
                console.error('Erreur:', error);
                alert("Erreur de connexion avec le serveur.");
            });
        });
    </script>
    <script src="{{ url_for('static', filename='funcion.js') }}"></script>
</body>
</html>